<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>二準位系スライダー教材（スマホ最適化）</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#555; --line:#e9e9ee;
      --radius:14px; --shadow: 0 1px 4px rgba(0,0,0,.08);
      --accent:#2f6df6;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0e0f14; --card:#151826; --text:#f3f4f8; --muted:#b7bbcc; --line:#262a3d; --shadow:none; --accent:#6aa3ff; }
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      line-height:1.35;
    }
    header{
      position: sticky; top:0; z-index:10;
      background: linear-gradient(to bottom, rgba(246,247,251,.95), rgba(246,247,251,.72));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      padding: 12px 14px;
    }
    @media (prefers-color-scheme: dark){
      header{ background: linear-gradient(to bottom, rgba(14,15,20,.92), rgba(14,15,20,.7)); }
    }
    h1{ font-size:16px; margin:0 0 6px; }
    .sub{ font-size:12px; color:var(--muted); margin:0; }
    .wrap{ padding: 12px 14px 18px; max-width: 980px; margin: 0 auto; }
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 12px;
    }
    .tabs{
      display:flex; gap:8px; padding: 10px 0 12px;
    }
    .tab{
      flex:1;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      text-align:center;
      touch-action: manipulation;
    }
    .tab[aria-selected="true"]{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--line));
      outline: 2px solid color-mix(in srgb, var(--accent) 38%, transparent);
    }
    .plotCard{ padding: 10px; }
    .plot{ height: 360px; }
    @media (max-width: 420px){
      .plot{ height: 330px; }
    }

    details{
      margin-top: 12px;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
      font-weight: 700;
      display:flex;
      align-items:center;
      justify-content: space-between;
      touch-action: manipulation;
    }
    summary::-webkit-details-marker{ display:none; }
    .chev{ width: 18px; height:18px; opacity:.7; }
    details[open] summary .chev{ transform: rotate(180deg); }
    .controls{ margin-top: 10px; padding: 12px; border-radius: 14px; background: var(--card); border:1px solid var(--line); }
    .row{ margin: 10px 0 14px; }
    .rowTop{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    label{ font-size: 13px; font-weight: 650; }
    .val{ font-variant-numeric: tabular-nums; color: var(--muted); font-size: 13px; }
    input[type=range]{ width:100%; height: 36px; }
    input[type=range]::-webkit-slider-thumb{ width: 24px; height: 24px; }
    input[type=range]::-moz-range-thumb{ width: 24px; height: 24px; }
    .btnrow{ display:flex; gap:10px; margin-top: 8px; flex-wrap: wrap; }
    button{
      flex:1;
      min-width: 120px;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-weight: 650;
      font-size: 13px;
      touch-action: manipulation;
    }
    button.primary{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--line));
      background: color-mix(in srgb, var(--accent) 10%, var(--card));
    }
    .mini{ font-size: 12px; color: var(--muted); margin-top: 10px; }
    .katex{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <header>
    <h1>二準位系スライダー教材（スマホ最適化）</h1>
    <p class="sub">
      <span class="katex">Ω</span>（Rabi）,
      <span class="katex">Δ</span>（離調）,
      <span class="katex">Γ</span>（減衰/線幅）を動かして、応答の変化を観察。
    </p>
  </header>

  <div class="wrap">
    <div class="tabs" role="tablist" aria-label="plots">
      <button id="tabTime" class="tab" role="tab" aria-selected="true" aria-controls="panelTime">Rabi振動</button>
      <button id="tabLine" class="tab" role="tab" aria-selected="false" aria-controls="panelLine">定常線形</button>
    </div>

    <div id="panelTime" class="card plotCard" role="tabpanel" aria-labelledby="tabTime">
      <div id="plotTime" class="plot"></div>
    </div>

    <div id="panelLine" class="card plotCard" role="tabpanel" aria-labelledby="tabLine" style="display:none;">
      <div id="plotLine" class="plot"></div>
    </div>

    <details open>
      <summary>
        パラメータ（タップで開閉）
        <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </summary>

      <div class="controls">
        <div class="row">
          <div class="rowTop">
            <label for="omega">Ω（Rabi周波数）</label>
            <div class="val" id="omegaVal"></div>
          </div>
          <input id="omega" type="range" min="0" max="20" step="0.1" value="2.0" />
        </div>

        <div class="row">
          <div class="rowTop">
            <label for="delta">Δ（離調）</label>
            <div class="val" id="deltaVal"></div>
          </div>
          <input id="delta" type="range" min="-20" max="20" step="0.1" value="0.0" />
        </div>

        <div class="row">
          <div class="rowTop">
            <label for="gamma">Γ（減衰/線幅スケール）</label>
            <div class="val" id="gammaVal"></div>
          </div>
          <input id="gamma" type="range" min="0" max="10" step="0.05" value="1.0" />
        </div>

        <div class="row">
          <div class="rowTop">
            <label for="tmax">t_max（時間範囲）</label>
            <div class="val" id="tmaxVal"></div>
          </div>
          <input id="tmax" type="range" min="1" max="50" step="0.5" value="10.0" />
        </div>

        <div class="row" style="margin-bottom:8px;">
          <div class="rowTop">
            <label for="drange">Δレンジ（線形）</label>
            <div class="val" id="drangeVal"></div>
          </div>
          <input id="drange" type="range" min="5" max="100" step="1" value="20" />
        </div>

        <div class="btnrow">
          <button id="presetRes" class="primary">共鳴（Δ=0）</button>
          <button id="presetDet">離調（Δ=+10）</button>
          <button id="presetStrong">強光（Ω=10）</button>
        </div>

        <div class="mini">
          モデル（直感用）：<br>
          ・Rabi振動：<span class="katex">P<sub>e</sub>(t)=(Ω²/Ω<sub>R</sub>²) sin²(Ω<sub>R</sub> t/2) e^{-Γ t}</span>（<span class="katex">Ω<sub>R</sub>=√(Ω²+Δ²)</span>）<br>
          ・定常線形：<span class="katex">s=2Ω²/Γ²</span>, <span class="katex">P<sub>e</sub><sup>ss</sup>(Δ)=(s/2)/(1+s+(2Δ/Γ)²)</span>
        </div>
      </div>
    </details>
  </div>

<script>
  function linspace(a, b, n) {
    const arr = new Array(n);
    const step = (b - a) / (n - 1);
    for (let i = 0; i < n; i++) arr[i] = a + step * i;
    return arr;
  }
  function fmt(x){
    const v = Math.round(x*100)/100;
    return v.toFixed(2);
  }
  function rabiPe(tArr, Omega, Delta, Gamma){
    const OR = Math.sqrt(Omega*Omega + Delta*Delta);
    if (OR === 0) return tArr.map(_ => 0);
    return tArr.map(t => {
      const s = Math.sin(OR * t / 2);
      return (Omega*Omega/(OR*OR)) * (s*s) * Math.exp(-Gamma * t);
    });
  }
  function steadyPe(dArr, Omega, Gamma){
    const Geff = (Gamma === 0) ? 1e-6 : Gamma;
    const s = 2 * Omega*Omega / (Geff*Geff);
    const Pe = dArr.map(d => (s/2) / (1 + s + Math.pow(2*d/Geff, 2)));
    return {Pe, s};
  }

  const omega = document.getElementById('omega');
  const delta = document.getElementById('delta');
  const gamma = document.getElementById('gamma');
  const tmax  = document.getElementById('tmax');
  const drange = document.getElementById('drange');

  const omegaVal = document.getElementById('omegaVal');
  const deltaVal = document.getElementById('deltaVal');
  const gammaVal = document.getElementById('gammaVal');
  const tmaxVal  = document.getElementById('tmaxVal');
  const drangeVal = document.getElementById('drangeVal');

  const tabTime = document.getElementById('tabTime');
  const tabLine = document.getElementById('tabLine');
  const panelTime = document.getElementById('panelTime');
  const panelLine = document.getElementById('panelLine');

  function selectTab(which){
    const isTime = (which === 'time');
    tabTime.setAttribute('aria-selected', isTime ? 'true' : 'false');
    tabLine.setAttribute('aria-selected', isTime ? 'false' : 'true');
    panelTime.style.display = isTime ? '' : 'none';
    panelLine.style.display = isTime ? 'none' : '';
    setTimeout(() => {
      Plotly.Plots.resize(isTime ? 'plotTime' : 'plotLine');
    }, 60);
  }
  tabTime.addEventListener('click', () => selectTab('time'));
  tabLine.addEventListener('click', () => selectTab('line'));

  document.getElementById('presetRes').addEventListener('click', () => { delta.value = 0; update(); });
  document.getElementById('presetDet').addEventListener('click', () => { delta.value = 10; update(); });
  document.getElementById('presetStrong').addEventListener('click', () => { omega.value = 10; update(); });

  function update(){
    const Om = parseFloat(omega.value);
    const De = parseFloat(delta.value);
    const Ga = parseFloat(gamma.value);
    const T  = parseFloat(tmax.value);
    const Dmax = parseFloat(drange.value);

    omegaVal.textContent = fmt(Om);
    deltaVal.textContent = fmt(De);
    gammaVal.textContent = fmt(Ga);
    tmaxVal.textContent  = fmt(T);
    drangeVal.textContent = fmt(Dmax);

    const N = 1400;
    const t = linspace(0, T, N);
    const Pe_t = rabiPe(t, Om, De, Ga);
    const OR = Math.sqrt(Om*Om + De*De);

    const timeTrace = { x: t, y: Pe_t, mode: 'lines', name: 'P_e(t)' };
    const timeLayout = {
      title: {text: 'A) Rabi振動（減衰つき）', font:{size:14}},
      margin: {l: 50, r: 10, t: 40, b: 45},
      xaxis: {title: 'time (arb. units)'},
      yaxis: {title: 'P_e(t)', range: [-0.02, 1.02]},
      annotations: [{
        xref:'paper', yref:'paper', x:0.02, y:0.98, showarrow:false, align:'left',
        text:`Ω=${fmt(Om)},  Δ=${fmt(De)},  Γ=${fmt(Ga)}<br>Ω_R=√(Ω²+Δ²)=${fmt(OR)}`,
        font:{size:12}
      }]
    };

    const ND = 1601;
    const d = linspace(-Dmax, Dmax, ND);
    const out = steadyPe(d, Om, Ga);
    const Pe_ss = out.Pe;
    const s = out.s;

    const lineTrace = { x: d, y: Pe_ss, mode: 'lines', name: 'P_e^ss(Δ)' };
    const lineLayout = {
      title: {text: 'B) 定常線形（飽和＆パワーブロードニング）', font:{size:14}},
      margin: {l: 50, r: 10, t: 40, b: 45},
      xaxis: {title: 'detuning Δ (arb. units)'},
      yaxis: {title: 'P_e^ss(Δ)', range: [-0.02, 0.52]},
      annotations: [{
        xref:'paper', yref:'paper', x:0.02, y:0.98, showarrow:false, align:'left',
        text:`s=2Ω²/Γ²=${fmt(s)}<br>（s↑で幅↑）`,
        font:{size:12}
      }]
    };

    const commonCfg = {displayModeBar: false, responsive: true};
    Plotly.react('plotTime', [timeTrace], timeLayout, commonCfg);
    Plotly.react('plotLine', [lineTrace], lineLayout, commonCfg);
  }

  [omega, delta, gamma, tmax, drange].forEach(el => el.addEventListener('input', update));
  update();
</script>
</body>
</html>
